/**
 * hybridJs JavaScript Game Engine v1.0.2
 * http://blog.weeblog.net
 *
 * Copyright 2010, Nils Roeder
 * Licensed under GPL Version 2 license.
 *
 * Date: Sun Dec 12 13:17:07 2010 +0100
 */
function hybridBlit(){function h(){f();p()}function m(){f();p();o.drawImage(n,0,0)}var o,i,n,g,f=function(){var a=i.getDimension()[0],d=i.getDimension()[1],b=i.getPosition()[0],c=i.getPosition()[1],q=i.getGameDimension()[1],k=b%a,e=c%d,j=0,r=0,l=a-k,s=d-e,t=parseInt(Math.floor(c/d)*q+Math.floor(b/a),10),u=resourceManager.getMapById(t);u!==0&&g.drawImage(u.getImage(),k,e,l,s,j,r,l,s);if(k>0){k=0;j=l;l=a-l;t+=1;u=resourceManager.getMapById(t);u!==0?g.drawImage(u.getImage(),k,e,l,s,j,r,l,s):g.fillRect(j,
r,l,s)}if(c%d>0){k=b%a;j=e=0;r=s;l=a-k;s=d-s;t=t-1+q;u=resourceManager.getMapById(t);u!==0?g.drawImage(u.getImage(),k,e,l,s,j,r,l,s):g.fillRect(j,r,l,s)}l=b%a;s=c%d;if(s>0&&l>0){e=k=0;j=a-b%a;r=d-c%d;t+=1;u=resourceManager.getMapById(t);u!==0?g.drawImage(u.getImage(),k,e,l,s,j,r,l,s):g.fillRect(j,r,l,s)}},p=function(){var a=resourceManager.getSpriteList();a.length>0&&$.each(a,function(d,b){var c=b.getDimension()[0],q=b.getDimension()[1],k=b.getPosition()[0]-i.getPosition()[0],e=b.getPosition()[1]-
i.getPosition()[1],j=0,r=0;if(b.getAnimation()!==null){j=(b.getAnimation().getIndex()[0]-1)*c;r=(b.getAnimation().getIndex()[1]-1)*q}g.drawImage(b.getImage(),j,r,c,q,k,e,c,q)})};return{init:function(){i=resourceManager.getScreen();i.init();$('<canvas id="screen" style="border:1px solid black; background: #ccc;" width="'+i.getDimension()[0]+'" height="'+i.getDimension()[1]+'">').appendTo("#hybridRoot");var a=document.getElementById("screen");if(a.getContext){if(resourceManager.getDoubleBuffering()){o=
a.getContext("2d");n=document.createElement("canvas");n.width=a.width;n.height=a.height;g=n.getContext("2d");this.blitFrame=m}else{g=a.getContext("2d");this.blitFrame=h}if(resourceManager.getVoidMap()){a=resourceManager.getMapById(-1);if(a!==0){a=g.createPattern(a.getImage(),"repeat");g.fillStyle=a}}}i.setContext(g)},blitFrame:function(){}}}
function hybridGame(){var h=0,m=0,o,i,n,g,f,p=function(r){n=r},a=function(){n!==null&&n.length>0&&$.each(n,function(r,l){if(l.getLifetime()>0){var s=resourceManager.getSpritesByType("player");s.length>0&&$.each(s,function(t,u){if(i.boxCollision(u,l)){l.triggerEvents();l.setLifetime(l.getLifetime()-1)}})}})},d=function(r,l){g=r;f=l;if(k()){b();q()}},b=function(){clearInterval(h);h=0;clearTimeout(m);m=0},c=function(){m=setTimeout(function(){i.moveFrame();a();e();c()},f)},q=function(){h=setInterval(function(){o.blitFrame();
j()},g);c()},k=function(){if(h!==0)return true;return false},e=function(){},j=function(){};return{init:function(r,l,s){b();resourceManager.init();r=hybridBlit();i=hybridMove();o=r;n=0;typeof s==="function"&&s()},load:function(r,l){hybridLoader().load(r,l)},start:function(r){o.init();i.init();d(resourceManager.getDisplaySpeed(),resourceManager.getGameSpeed());p(resourceManager.getTriggerByType("coordinate"));var l=resourceManager.getTriggerByType("start");l.length>0&&$.each(l,function(s,t){t.triggerEvents();
t.setLifetime(t.getLifetime()-1)});q();typeof r==="function"&&r()},stop:b,run:q,isRunning:k,quit:function(){b();i=o=0;position=[0,0];n=f=g=0;resourceManager.init()},setGameplayHook:function(r){if(typeof r==="function")e=r},setDisplayHook:function(r){if(typeof r==="function")j=r}}}
function hybridLoader(){function h(){var b=resourceManager.getPrototypeList(),c=resourceManager.getMapList(),q=0,k=0;$("#loading").text("waiting for sprite images ["+q+"/"+b.length+"]");b.length>0&&$.each(b,function(e,j){j.getReady()&&q++});$("#loading").text("waiting for tile images ["+k+"/"+c.length+"]");c.length>0&&$.each(c,function(e,j){j.getReady()&&k++});clearInterval(a);typeof p==="function"&&p()}function m(b){$(b).find("game").each(function(){var c=$(this).find("displaySpeed").text();c!==
undefined&&resourceManager.setDisplaySpeed(c);c=$(this).find("gameSpeed").text();c!==undefined&&resourceManager.setGameSpeed(c);c=$(this).find("border").text();c!==undefined&&resourceManager.setBorder(c);c=$(this).find("collision").text();resourceManager.setCollisionAccuracy(c);c=$(this).find("doubleBuffering").text();resourceManager.setDoubleBuffering(c);c=$(this).find("voidMap").text();resourceManager.setVoidMap(c);c=$(this).find("audio").text();resourceManager.setAudio(c)})}function o(b){$(b).find("screen").each(function(){var c=
resourceManager.getScreen(),q=$(this).find("dimension").text().split(" "),k=$(this).find("gamesize").text().split(" ");c.setDimension(q[0],q[1]);c.setGameDimension(k[0],k[1]);q=$(this).find("velocity").text().split(" ");q.length>1?c.setVelocity(q[0],q[1]):c.setVelocity(0,0)})}function i(b){$(b).find("map").each(function(){var c=resourceManager.getScreen(),q=hybridTile(),k=$(this).attr("type");if("void"!==k){var e=$(this).find("position").text().split(" ");q.setPosition(e[0],e[1]);var j=parseInt(e[1],
10),r=parseInt(c.getGameDimension()[1],10),l=parseInt(e[0],10);q.setId(j*r+l)}else q.setId(-1);j=new Image;j.onload=q.setReady;j.src=$(this).find("image").text();q.setImage(j);"start"===k&&c.setPosition(e[0]*c.getDimension()[0],e[1]*c.getDimension()[1]);c=$(this).find("velocity").text().split(" ");c.length>1&&q.setVelocity(c[0],c[1]);resourceManager.addMap(q)})}function n(b){$(b).find("sound").each(function(){var c=hybridSound(),q=$(this).attr("id"),k=$(this).find("file").text(),e=$(this).find("volume").text(),
j=new Audio(k);j.src=k;j.load();c.setId(q);c.setFile(k);c.setVolume(e);c.setSound(j);resourceManager.addSound(c)})}function g(b){$(b).find("prototype").each(function(){var c=hybridSpritePrototype(),q=$(this).attr("id"),k=new Image;k.onload=c.setReady;k.src=$(this).find("image").text();c.setId(q);c.setImage(k);$(this).find("animation").each(function(){var e=$(this).find("frames").text(),j=$(this).find("rows").text(),r=$(this).find("delay").text();c.setAnimation(true);c.setAnimationFrames(e);c.setAnimationRows(j);
c.setAnimationDelay(r)});resourceManager.addPrototype(c)})}function f(b){$(b).find("trigger").each(function(){var c=hybridTrigger();c.setType($(this).attr("type"));c.setLifetime($(this).attr("lifetime"));var q=$(this).find("box").text().split(" ");q.length===4&&c.setTriggerbox(q[0],q[1],q[2],q[3]);$(this).find("event").each(function(){var k=$(this).attr("type"),e=$(this).attr("prototype"),j=$(this).attr("name"),r=$(this).find("layer").text(),l=$(this).find("mode").text().split(" ");$(this).find("gameplay").text().split(" ");
var s=$(this).find("vitality").text().split(" "),t=$(this).find("velocity").text().split(" "),u=$(this).find("created").text(),x=$(this).find("destroyed").text(),y=$(this).find("movement").text(),z=$(this).find("impact").text(),A=$(this).find("damage").text();$(this).find("sprite").each(function(){var w=$(this).find("position").text().split(" "),v=hybridEvent();v.setType(k);v.setPrototype(e);j!==undefined&&v.setName(j);r!==""&&v.setLayer(r);w.length>1&&v.setPosition(w[0],w[1]);l.length>1&&v.setMode(l[0],
l[1],l[2],l[3]);u!==""&&v.setCreated(u);x!==""&&v.setDestroyed(x);y!==""&&v.setMovement(y);z!==""&&v.setImpact(z);A!==""&&v.setDamage(A);s.length>1&&v.setVitality(s[0],s[1]);t.length>1&&v.setVelocity(t[0],t[1]);c.addEvent(v)})});resourceManager.addTrigger(c)})}var p=0,a=0,d=function(b){$("#loading").text("parsing game data");m(b);$("#loading").text("parsing screen data");o(b);$("#loading").text("parsing map data");i(b);$("#loading").text("parsing sound data");n(b);$("#loading").text("parsing image data");
g(b);$("#loading").text("parsing event data");f(b);a=setInterval(h,100)};return{load:function(b,c){p=c;$("#loading").text("before parsing");$.ajax({type:"GET",async:false,url:b,dataType:"xml",success:d})},write:function(){}}}
function hybridMove(){var h=null,m=null,o=null,i=function(){var f=resourceManager.getSpriteList();f.length>0&&$.each(f,function(p,a){if(a.getActive()===true){a.move();var d=a.getPosition(),b=a.getDimension()[0],c=a.getDimension()[1];if(m==="screen"){if(d[0]+b<h.getPosition()[0]||d[1]+c<h.getPosition()[1]||d[0]>h.getPosition()[0]+h.getDimension()[0]||d[1]>h.getPosition()[1]+h.getDimension()[1])a.setInactive()}else if(m==="map")if(d[0]+b<0||d[1]+c<0||d[0]>h.getDimension()[0]*h.getGameDimension()[0]||
d[1]>h.getDimension()[1]*h.getGameDimension()[1])a.setInactive()}})},n=function(){var f=resourceManager.getSpriteList();$.each(f,function(p,a){$.each(f,function(d,b){if(p>d&&a.getId()!==b.getId()&&a.getActive()===true&&b.getActive()===true&&a.getVitality()[0]>0&&b.getVitality()[0]>0)if(g(a,b)){a.getPosition();a.getPosition();a.getDimension();a.getDimension();b.getPosition();b.getPosition();b.getDimension();b.getDimension();var c=false;if(o)c=true;if(c&&o||!o)if(a.getMode()[3]!==b.getMode()[3]){if(a.getMode()[0]>
0)if(b.getMode()[0]>0){a.impact(b.getMode()[0]);b.impact(a.getMode()[0])}a.getMode()[2]>0&&b.getMode()[1]>0&&a.damage(b.getMode()[1]);b.getMode()[2]>0&&a.getMode()[1]>0&&b.damage(a.getMode()[1])}}})})},g=function(f,p){var a=[f.getPosition()[0],f.getPosition()[1]],d=[p.getPosition()[0],p.getPosition()[1]],b=[f.getDimension()[0],f.getDimension()[1]],c=[p.getDimension()[0],p.getDimension()[1]];if(!(a[0]+b[0]<d[0])&&!(a[0]>d[0]+c[0])&&!(a[1]+b[1]<d[1])&&!(a[1]>d[1]+c[1]))return true;return false};return{init:function(){h=
resourceManager.getScreen();m=resourceManager.getBorder();o=resourceManager.getCollisionAccuracy()},pixelCollision:function(){return true},boxCollision:g,moveFrame:function(){h.move();i();n();for(var f=resourceManager.getSpriteList(),p=0;p<f.length;p++)f[p].getActive()===false&&f.splice(p,1)}}}
var resourceManager=function(){var h=[],m=[],o=[],i=[],n=[],g,f,p,a="screen",d=true,b=true,c=true,q=true,k=false;return{setDebug:function(e){k=e},getDebug:function(){return k},init:function(){g=hybridScreen();h=[];m!==null&&m!==0&&m!==undefined&&m.length>0&&$.each(m,function(e,j){j.getAnimation().stop()});m=[];o=[];i=[];n=[];speed=0},setCollisionAccuracy:function(e){q=e==="pixel"?true:false},getCollisionAccuracy:function(){return q},setDoubleBuffering:function(e){d=e==="on"?true:false},getDoubleBuffering:function(){return d},
setVoidMap:function(e){b=e==="on"?true:false},getVoidMap:function(){return b},setAudio:function(e){c=e==="on"?true:false},getAudio:function(){return c},setBorder:function(e){a=e},getBorder:function(){return a},setDisplaySpeed:function(e){f=e},getDisplaySpeed:function(){return f},setGameSpeed:function(e){p=e},getGameSpeed:function(){return p},getScreen:function(){return g},getMapList:function(){return h},getMapById:function(e){var j=0;$.each(h,function(r,l){if(parseInt(l.getId(),10)===e)j=l});return j},
addMap:function(e){h.push(e);return h},getSpriteList:function(){return m},getSpriteById:function(e){var j=0;$.each(m,function(r,l){if(parseInt(l.getId(),10)===e)j=l});return j},getSpritesByType:function(e){var j=[];$.each(m,function(r,l){l.getType()===e&&j.push(l)});return j},getSpritesByName:function(e){var j=[];$.each(m,function(r,l){l.getName()===e&&j.push(l)});return j},addSprite:function(e){m.push(e);return m},getNewSpriteId:function(){var e=1;if(m.length>0)e=parseInt(m[m.length-1].getId()+1,
10);return e},getSoundList:function(){return o},getSoundById:function(e){var j=0;$.each(o,function(r,l){if(l.getId()===e)j=l});return j},addSound:function(e){o.push(e);return o},getPrototypeList:function(){return i},getPrototypeById:function(e){var j=0;$.each(i,function(r,l){if(l.getId()===e)j=l});return j},addPrototype:function(e){i.push(e);return i},getTriggerList:function(){return n},getTriggerByType:function(e){var j=[];$.each(n,function(r,l){l.getType()===e&&j.push(l)});return j},addTrigger:function(e){n.push(e);
return n}}}();
function hybridScreen(){var h=[2],m=[2],o=[2],i=[2],n;return{init:function(){$("#hybridRoot").empty()},setContext:function(g){n=g},getContext:function(){return n},setGameDimension:function(g,f){h[0]=parseInt(g,10);h[1]=parseInt(f,10)},getGameDimension:function(){return h},setDimension:function(g,f){m[0]=parseInt(g,10);m[1]=parseInt(f,10)},getDimension:function(){return m},setPosition:function(g,f){if(g<0)g=0;if(f<0)f=0;if(g>h[0]*m[0])g=h[0]*m[0]-1;if(f>h[1]*m[1])f=h[1]*m[1]-1;o[0]=parseInt(g,10);
o[1]=parseInt(f,10)},getPosition:function(){return o},setVelocity:function(g,f){i[0]=parseInt(g,10);i[1]=parseInt(f,10)},getVelocity:function(){return i},move:function(){this.setPosition(o[0]+i[0],o[1]+i[1])}}}
function hybridSound(){var h="",m=0,o=false,i=100,n=null;return{setReady:function(){o=true},getReady:function(){return o},setId:function(g){m=g},getId:function(){return m},setSound:function(g){n=g},getSound:function(){return n},setFile:function(g){h=g},getFile:function(){return h},setVolume:function(g){i=parseInt(g,10)},getVolume:function(){return i}}}
function hybridSprite(){var h=[2],m=[2],o=[2],i,n,g=0,f="",p="sprite",a=1,d=null,b=[1,1],c=[3,3,3,3],q=true;return{setLayer:function(k){a=parseInt(k,10)},getLayer:function(){return a},setImage:function(k){i=k},getImage:function(){return i},setImageData:function(k){n=k},getImageData:function(){return n},setId:function(k){g=parseInt(k,10)},getId:function(){return g},setName:function(k){f=k},getName:function(){return f},setType:function(k){p=k},getType:function(){return p},setPosition:function(k,e){h[0]=
parseInt(k,10);h[1]=parseInt(e,10)},getPosition:function(){return h},setDimension:function(k,e){m[0]=parseInt(k,10);m[1]=parseInt(e,10)},getDimension:function(){return m},setVelocity:function(k,e){o[0]=parseInt(k,10);o[1]=parseInt(e,10)},getVelocity:function(){return o},setVitality:function(k,e){b[0]=parseInt(k,10);b[1]=parseInt(e,10)},getVitality:function(){return b},setMode:function(k,e,j,r){c[0]=parseInt(k,10);c[1]=parseInt(e,10);c[2]=parseInt(j,10);c[3]=parseInt(r,10)},getMode:function(){return c},
setAnimation:function(k){d=k},getAnimation:function(){return d},setInactive:function(){q=false},getActive:function(){return q},move:function(){},impact:function(){},damage:function(){},created:function(){},destroyed:function(){}}}
function hybridAnimation(h,m,o){var i=0,n=0,g=0,f=1,p=1,a="forward",d=null,b=0;return{getId:function(){return h},setFrames:function(c){i=parseInt(c,10)},getFrames:function(){return i},setRows:function(c){n=parseInt(c,10)},getRows:function(){return n},setDelay:function(c){g=parseInt(c,10)},getDelay:function(){return g},setDirection:function(c){a=c},getDirection:function(){return a},getDimension:function(){return[parseInt(m/i,10),parseInt(o/n,10)]},setIndex:function(c,q){f=c;p=q},getIndex:function(){return[f,
p]},start:function(c,q,k,e,j){d!==null&&this.stop();f=1;if(c>0)f=c;p=1;if(q>0)p=q;if(f>i)f=i;if(p>n)p=n;a="forward";if(k!==null)a=k;b=-1;if(e!==null)b=e;if(i>1){var r=this;d=setInterval(function(){if(a==="reverse"){f--;if(f<0){f=i;if(b>0){b--;typeof j==="function"&&j()}}}else{f++;if(f>i){f=1;if(b>0){b--;typeof j==="function"&&j()}}}b===0&&r.stop()},g)}},stop:function(){if(d!==null){clearInterval(d);d=null;b=0;p=f=1}}}}
function hybridSpritePrototype(){var h,m,o=0,i=false,n=0,g=0,f=0,p=false;return{setReady:function(){this.createImageData();p=true},getReady:function(){return p},setImage:function(a){h=a},getImage:function(){return h},createImageData:function(){$('<canvas id="binaryCanvas" width="'+h.width+'" height="'+h.height+'">').appendTo("#hybridRoot");var a=document.getElementById("binaryCanvas"),d=a.getContext("2d");d.drawImage(h,0,0);a=d.getImageData(0,0,a.width,a.height);m=[h.width];for(d=0;d<h.width;d++){m[d]=
[h.height];for(var b=0;b<h.height;b++)m[d][b]=a.data[(d+b*h.width)*4+3]}$("#binaryCanvas").remove()},getImageData:function(){return m},setId:function(a){o=a},getId:function(){return o},setAnimation:function(a){i=a},getAnimation:function(){return i},setAnimationFrames:function(a){n=a},getAnimationFrames:function(){return n},setAnimationRows:function(a){g=a},getAnimationRows:function(){return g},setAnimationDelay:function(a){f=a},getAnimationDelay:function(){return f},activate:function(a){var d=hybridSprite();
d.setId(resourceManager.getNewSpriteId());d.setImage(this.getImage());d.setImageData(this.getImageData());d.setDimension(this.getImage().width,this.getImage().height);d.setLayer(a.getLayer());d.setType(a.getType());d.setName(a.getName());d.setPosition(a.getPosition()[0],a.getPosition()[1]);d.setVelocity(a.getVelocity()[0],a.getVelocity()[1]);d.setVitality(a.getVitality()[0],a.getVitality()[1]);d.setMode(a.getMode()[0],a.getMode()[1],a.getMode()[2],a.getMode()[3]);if(i===true){var b=hybridAnimation(d.getId(),
h.width,h.height);b.setFrames(this.getAnimationFrames());b.setRows(this.getAnimationRows());b.setDelay(this.getAnimationDelay());d.setAnimation(b);d.setDimension(b.getDimension()[0],b.getDimension()[1])}resourceManager.addSprite(d);b=hybridSpriteGameplay(d);if(b!==null){d.move=b.getMovement(a.getMovement());d.impact=b.getImpact(a.getImpact());d.damage=b.getDamage(a.getDamage());d.created=b.getCreated(a.getCreated());d.destroyed=b.getDestroyed(a.getDestroyed())}d.created();return d.getId()}}}
function hybridTile(){var h=[2],m=[0,0],o="",i=0,n=false,g=false;return{setReady:function(){g=true},getReady:function(){return g},setId:function(f){i=parseInt(f,10)},getId:function(){return i},isActive:function(){return n},setActive:function(f){n=f},setPosition:function(f,p){h[0]=parseInt(f,10);h[1]=parseInt(p,10)},getPosition:function(){return h},setVelocity:function(f,p){m[0]=parseInt(f,10);m[1]=parseInt(p,10)},getVelocity:function(){return m},setImage:function(f){o=f},getImage:function(){return o}}}
function hybridTrigger(){var h=1,m="coordinate",o=[4],i=[];return{setLifetime:function(n){h=parseInt(n,10)},getLifetime:function(){return h},setType:function(n){m=n},getType:function(){return m},setTriggerbox:function(n,g,f,p){o[0]=parseInt(n,10);o[1]=parseInt(g,10);o[2]=parseInt(f,10);o[3]=parseInt(p,10)},getTriggerbox:function(){return o},getPosition:function(){return[o[0],o[1]]},getDimension:function(){return[o[2],o[3]]},addEvent:function(n){i.push(n);return i},getEventList:function(){return i},
getEventByName:function(n){var g=0;$.each(i,function(f,p){if(p.getName()===n)g=p});return g},triggerEvents:function(){i.length>0&&$.each(i,function(n,g){resourceManager.getPrototypeById(g.getPrototype()).activate(g)})}}}
function hybridEvent(){var h="",m=0,o="sprite",i=1,n=[0,0],g=[0,0],f=[1,1],p=[0,0,0,0],a=[0,0,0,0,0];return{setName:function(d){h=d},getName:function(){return h},setPrototype:function(d){m=d},getPrototype:function(){return m},setType:function(d){o=d},getType:function(){return o},setLayer:function(d){i=parseInt(d,10)},getLayer:function(){return i},setPosition:function(d,b){n[0]=parseInt(d,10);n[1]=parseInt(b,10)},getPosition:function(){return n},setVelocity:function(d,b){g[0]=parseInt(d,10);g[1]=parseInt(b,
10)},getVelocity:function(){return g},setVitality:function(d,b){f[0]=parseInt(d,10);f[1]=parseInt(b,10)},getVitality:function(){return f},setMode:function(d,b,c,q){p[0]=parseInt(d,10);p[1]=parseInt(b,10);p[2]=parseInt(c,10);p[3]=parseInt(q,10)},getMode:function(){return p},setMovement:function(d){a[0]=parseInt(d,10)},getMovement:function(){return a[0]},setImpact:function(d){a[1]=parseInt(d,10)},getImpact:function(){return a[1]},setDamage:function(d){a[2]=parseInt(d,10)},getDamage:function(){return a[2]},
setCreated:function(d){a[3]=parseInt(d,10)},getCreated:function(){return a[3]},setDestroyed:function(d){a[4]=parseInt(d,10)},getDestroyed:function(){return a[4]}}};
